stages:
  - build
  - test
  - quality
  - package

variables:
  BUILD_DIR: build
  CMAKE_BUILD_TYPE: Release

# Linux build
build_linux:
  stage: build
  image: ubuntu:20.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq cmake build-essential libsfml-dev
  script:
    - mkdir -p $BUILD_DIR
    - cd $BUILD_DIR
    - cmake .. -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE
    - make -j$(nproc)
  artifacts:
    paths:
      - $BUILD_DIR/
    expire_in: 1 week
  tags:
    - linux

# Windows build
build_windows:
  stage: build
  image: mcr.microsoft.com/windows/servercore:ltsc2019
  before_script:
    - choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
    - choco install sfml
  script:
    - mkdir $BUILD_DIR
    - cd $BUILD_DIR
    - cmake .. -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE
    - cmake --build . --config $CMAKE_BUILD_TYPE
  artifacts:
    paths:
      - $BUILD_DIR/
    expire_in: 1 week
  tags:
    - windows

# Unit tests
test_linux:
  stage: test
  image: ubuntu:20.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq cmake build-essential libsfml-dev libgtest-dev
  script:
    - mkdir -p $BUILD_DIR
    - cd $BUILD_DIR
    - cmake .. -DCMAKE_BUILD_TYPE=Debug
    - make -j$(nproc)
    - ctest --output-on-failure
  needs:
    - build_linux
  tags:
    - linux

# Code quality
quality_check:
  stage: quality
  image: ubuntu:20.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq cppcheck clang-format
  script:
    - cppcheck --enable=all --std=c++17 src/ include/
    - find src/ include/ -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror
  tags:
    - linux

# Package
package_linux:
  stage: package
  image: ubuntu:20.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq cmake build-essential libsfml-dev
  script:
    - mkdir -p $BUILD_DIR
    - cd $BUILD_DIR
    - cmake .. -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE
    - make -j$(nproc)
    - cpack
  artifacts:
    paths:
      - $BUILD_DIR/*.deb
      - $BUILD_DIR/*.tar.gz
    expire_in: 1 month
  needs:
    - build_linux
  tags:
    - linux